{% extends "products/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">Настройки</h1>
    <span class="badge bg-primary">
        {% if user.is_superuser %}<i class="bi bi-shield-lock me-1"></i>Суперпользователь{% else %}<i class="bi bi-person me-1"></i>Менеджер{% endif %}
    </span>
    {% if user.is_superuser %}
    <button class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#addManagerModal">
        <i class="bi bi-person-plus me-1"></i>Добавить менеджера
    </button>
    {% endif %}
  </div>

<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header d-flex align-items-center"><i class="bi bi-palette me-2"></i><h5 class="mb-0">Тема интерфейса</h5></div>
      <div class="card-body">
        <div class="d-flex gap-3 mb-3">
          <button type="button" class="btn btn-outline-secondary theme-btn" data-theme="light">
            <i class="bi bi-brightness-high me-1"></i>Светлая
          </button>
          <button type="button" class="btn btn-outline-secondary theme-btn" data-theme="dark">
            <i class="bi bi-moon me-1"></i>Тёмная
          </button>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">Сохраняется в браузере (LocalStorage)</small>
          <button type="button" id="applyTheme" class="btn btn-primary btn-sm"><i class="bi bi-check2 me-1"></i>Применить</button>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header d-flex align-items-center"><i class="bi bi-bell me-2"></i><h5 class="mb-0">Уведомления</h5></div>
      <div class="card-body">
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
          <label class="form-check-label" for="emailNotifications">Email уведомления</label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="lowStockAlerts" checked>
          <label class="form-check-label" for="lowStockAlerts">О низких остатках</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="weeklyReports">
          <label class="form-check-label" for="weeklyReports">Еженедельные отчёты</label>
        </div>
      </div>
    </div>
  </div>
</div>

{% if user.is_superuser %}
<div class="card">
  <div class="card-header d-flex align-items-center"><i class="bi bi-people me-2"></i><h5 class="mb-0">Пользователи</h5></div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Имя</th><th>Роль</th><th>Email</th><th>Последний вход</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ user.get_full_name|default:user.username }}</td>
            <td><span class="badge bg-danger">Суперпользователь</span></td>
            <td>{{ user.email|default:"—" }}</td>
            <td>{{ user.last_login|date:"d.m.Y H:i"|default:"Никогда" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
}</div>
{% endif %}

<!-- Modal: Добавить менеджера -->
{% if user.is_superuser %}
<div class="modal fade" id="addManagerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Добавить менеджера</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addManagerForm">
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">Имя</label><input type="text" class="form-control" id="mFirstName" required></div>
          <div class="mb-3"><label class="form-label">Фамилия</label><input type="text" class="form-control" id="mLastName" required></div>
          <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="mEmail" required></div>
          <div class="mb-3"><label class="form-label">Имя пользователя</label><input type="text" class="form-control" id="mUsername" required></div>
          <div class="mb-3"><label class="form-label">Пароль</label><input type="password" class="form-control" id="mPassword" minlength="8" required></div>
          <div class="mb-2"><label class="form-label">Разрешения</label>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="permViewProducts" checked><label class="form-check-label" for="permViewProducts">Просмотр товаров</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="permEditProducts"><label class="form-check-label" for="permEditProducts">Редактирование товаров</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="permViewSales" checked><label class="form-check-label" for="permViewSales">Просмотр продаж</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="permMakeSales" checked><label class="form-check-label" for="permMakeSales">Проведение продаж</label></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check2 me-1"></i>Создать</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Тема: инициализация
  const saved = localStorage.getItem('theme') || 'light';
  markActive(saved);

  // Кнопки выбора темы
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => markActive(btn.dataset.theme));
  });

  // Применить тему
  document.getElementById('applyTheme').addEventListener('click', () => {
    const active = document.querySelector('.theme-btn.active')?.dataset.theme || 'light';
    localStorage.setItem('theme', active);
    applyTheme(active);
    toast('Тема применена');
  });

  // Модалка менеджера (демо-обработка)
  const form = document.getElementById('addManagerForm');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      toast('Менеджер создан (демо)');
      const modalEl = document.getElementById('addManagerModal');
      bootstrap.Modal.getInstance(modalEl)?.hide();
      form.reset();
    });
  }

  // Автоприменение сохранённой темы
  applyTheme(saved);
});

function markActive(theme) {
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`.theme-btn[data-theme="${theme}"]`);
  if (btn) btn.classList.add('active');
}

function applyTheme(theme) {
  const root = document.documentElement;
  if (theme === 'dark') {
    root.style.setProperty('--primary-color', '#4dabf7');
    root.style.setProperty('--secondary-color', '#868e96');
    document.body.classList.add('dark-theme');
  } else {
    root.style.setProperty('--primary-color', '#3b7ddd');
    root.style.setProperty('--secondary-color', '#6c757d');
    document.body.classList.remove('dark-theme');
  }
}

function toast(msg) {
  const el = document.createElement('div');
  el.className = 'alert alert-success position-fixed top-0 end-0 m-3';
  el.style.zIndex = 1080;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}
</script>
{% endblock %}

